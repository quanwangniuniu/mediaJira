openapi: 3.1.0
info:
  title: Optimization Scaling API
  version: 1.0.0
  description: API specification for Experiment Tracking, Scaling Actions, and Rollback APIs.
servers:
  - url: http://localhost:8000/
paths:
  /optimization/experiments/:
    get:
      tags: [Experiments]
      summary: List experiments
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [running, paused, completed, rolled_back]
        - name: experiment_type
          in: query
          schema:
            type: string
            enum: [ab_test, creative_rotation, budget_split]
        - name: start_before
          in: query
          description: Return experiments with start_date before this datetime
          schema:
            type: string
            format: date-time
        - name: end_after
          in: query
          description: Return experiments with end_date after this datetime
          schema:
            type: string
            format: date-time
        - name: page
          in: query
          schema: { type: integer, minimum: 1, default: 1 }
        - name: page_size
          in: query
          schema: { type: integer, minimum: 1, maximum: 50, default: 20 }
      responses:
        '200':
          description: List of filtered experiments with pagination
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedExperiments'
    post:
      tags: [Experiments]
      summary: Create experiment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExperimentCreate'
            examples:
              createExperiment:
                value:
                  name: Holiday Creative Test
                  description: Test to determine if Holiday Creative is more effective than Non-Holiday Creative
                  created_by: 42
                  experiment_type: ab_test
                  linked_campaign_ids: ["fb:123", "tt:456"]
                  hypothesis: Creative A will outperform Creative B in CTR
                  start_date: "2025-09-01"
                  end_date: "2025-09-14"
                  status: running
      responses:
        '201':
          description: Experiment created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Experiment'
        '400':
          description: Bad Request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /optimization/experiments/{id}/:
    patch:
      tags: [Experiments]
      summary: Update experiment
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExperimentUpdate'
      responses:
        '200':
          description: Experiment updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Experiment'
        '400':
          description: Bad Request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /optimization/experiments/{id}/metrics/:
    get:
      tags: [Metrics]
      summary: Get experiment metrics for a given experiment
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 20, default: 10 }
      responses:
        '200':
          description: Paginated metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedMetrics'
        '400':
          description: Bad Request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /optimization/experiments/{id}/metrics/ingest/:
    post:
      tags: [Metrics]
      summary: Ingest experiment metric
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MetricIngest' }
            examples:
              ingestMetric:
                value:
                  metric_name: abc
                  metric_value: 123
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricIngest'
        '400':
          description: Bad Request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /optimization/scaling/:
    get:
      tags: [Scaling]
      summary: List scaling actions
      parameters:
        - name: action_type
          in: query
          schema:
            type: string
            enum: [ budget_increase, budget_decrease, audience_expand, audience_narrow, creative_replace ]
        - name: campaign_id
          in: query
          schema: { type: string }
        - name: performed_before
          in: query
          description: Filter actions performed before this datetime
          schema: { type: string, format: date-time }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
      responses:
        '200':
          description: Paginated scaling actions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedScalingActions'
    post:
      tags: [Scaling]
      summary: Apply scaling action
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScalingActionCreate'
            examples:
              scalingAction:
                value:
                  campaign_id: "fb:123"
                  action_type: budget_increase
                  action_details: { increase_pct: 25 }
                  performed_by: 42
      responses:
        '201':
          description: Scaling action created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScalingAction'
        '400':
          description: Bad Request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /optimization/scaling/{id}/rollback/:
    post:
      tags: [Scaling]
      summary: Rollback scaling action
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RollbackRequest'
      responses:
        '201':
          description: History of rollback action
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RollbackHistory'
        '400':
          description: Bad Request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /optimization/scaling-plans/:
    get:
      tags: [Scaling]
      summary: List scaling plans
      parameters:
        - name: task_id
          in: query
          schema:
            type: integer
          description: Filter scaling plans by parent task ID
      responses:
        '200':
          description: List of scaling plans
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ScalingPlan'
    post:
      tags: [Scaling]
      summary: Create scaling plan
      description: Create a high-level scaling plan for a Task of type "scaling".
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScalingPlanCreate'
      responses:
        '201':
          description: Scaling plan created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScalingPlan'
        '400':
          description: Bad Request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /optimization/scaling-plans/{id}/:
    get:
      tags: [Scaling]
      summary: Get scaling plan
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Scaling plan details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScalingPlan'
        '404':
          description: Not Found
    patch:
      tags: [Scaling]
      summary: Update scaling plan
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScalingPlanUpdate'
      responses:
        '200':
          description: Updated scaling plan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScalingPlan'
        '400':
          description: Bad Request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /optimization/scaling-plans/{plan_id}/steps/:
    get:
      tags: [Scaling]
      summary: List scaling steps for plan
      parameters:
        - name: plan_id
          in: path
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: List of scaling steps
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ScalingStep'
    post:
      tags: [Scaling]
      summary: Create scaling step for plan
      parameters:
        - name: plan_id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScalingStepCreate'
      responses:
        '201':
          description: Scaling step created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScalingStep'
        '400':
          description: Bad Request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /optimization/scaling-steps/{id}/:
    get:
      tags: [Scaling]
      summary: Get scaling step
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Scaling step details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScalingStep'
        '404':
          description: Not Found
    patch:
      tags: [Scaling]
      summary: Update scaling step
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScalingStepUpdate'
      responses:
        '200':
          description: Updated scaling step
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScalingStep'
        '400':
          description: Bad Request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
    delete:
      tags: [Scaling]
      summary: Delete scaling step
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        '204':
          description: Scaling step deleted
        '404':
          description: Not Found

components:
  schemas:
    Experiment:
      type: object
      required: [id, name, description, start_date, end_date, experiment_type, status]
      properties:
        id:
          type: int
        name:
          type: string
        description:
          type: string
        created_by:
          type: int
          desciption: User ID of the creator, FK
        experiment_type:
          type: string
          enum: [ab_test, creative_rotation, budget_split]
        linked_campaign_ids:
          type: array
          items: { type: string }
          description: Store Campaign IDs from multiple platforms, e.g., "tiktok:26"
        hypothesis:
          type: string
        status:
          type: string
          enum: [running, paused, completed, rolled_back]
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date

    ExperimentCreate:
      type: object
      required: [name, experiment_type, start_date, status, created_by, linked_campaign_ids, hypothesis, end_date, description]
      properties:
        name:
          type: string
        experiment_type:
          type: string
          enum: [ab_test, creative_rotation, budget_split]
        linked_campaign_ids:
          type: array
          items: { type: string }
        hypothesis:
          type: string
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        status:
          type: string
          enum: [running, paused, completed, rolled_back]
        description:
          type: string
        created_by:
          type: int

    ExperimentUpdate:
      type: object
      properties:
        name: 
          type: string
        experiment_type:
          type: string
          enum: [ab_test, creative_rotation, budget_split]
        linked_campaign_ids:
          type: array
          items: { type: string }
        hypothesis: 
          type: string
        status:
          type: string
          enum: [running, paused, completed, rolled_back]
        start_date: { type: string, format: date }
        end_date: { type: string, format: date}
        description: { type: string }

    Metric:
      type: object
      required: [id, metric_name, metri_value, recorded_at]
      properties:
        id:
          type: int
        experiment_id:
          type: int
        metric_name:
          type: string
        metric_value:
          type: number
        recorded_at:
          type: string
          format: date-time

    MetricIngest:
      type: object
      required: [metric_name, metri_value]
      properties:
        id:
          type: int
        experiment_id:
          type: int
        metric_name:
          type: string
        metric_value:
          type: number
        recorded_at:
          type: string
          format: date-time

    ScalingAction:
      type: object
      required: [ id, experiment_id, campaign_id, action_type, action_details, performed_at, performed_by]
      properties:
        id:
          type: int
        experiment_id: { type: [int, "null"] }
        campaign_id: { type: string }
        action_type:
          type: string
          enum: [ budget_increase, budget_decrease, audience_expand, audience_narrow, creative_replace ]
        action_details:
          type: object
        performed_at:
          type: string
          format: date-time
        performed_by: { type: int }

    ScalingActionCreate:
      type: object
      required: [campaign_id, action_type, action_details, performed_by]
      properties:
        campaign_id:
          type: string
        action_type:
          type: string
          enum: [ budget_increase, budget_decrease, audience_expand, audience_narrow, creative_replace ]
        action_details:
          type: object
        performed_by: { type: int }

    PaginatedExperiments:
      type: object
      properties:
        count: { type: integer }
        next: { type: [string, "null"], format: uri}
        previous: { type: [string, "null"], format: uri}
        results:
          type: array
          items: { $ref: '#/components/schemas/Experiment' }

    PaginatedMetrics:
      type: object
      properties:
        count: { type: integer }
        next: { type: [string, "null"], format: uri}
        previous: { type: [string, "null"], format: uri}
        results:
          type: array
          items: { $ref: '#/components/schemas/Metric' }

    PaginatedScalingActions:
      type: object
      properties:
        count: { type: integer }
        next: { type: [string, "null"], format: uri }
        previous: { type: [string, "null"], format: uri}
        results:
          type: array
          items: { $ref: '#/components/schemas/ScalingAction' }

    RollbackRequest:
      type: object
      required: [ reason, performed_by ]
      properties:
        reason: { type: string }
        performed_by: { type: int }
    
    RollbackHistory:
      type: object
      required: [ id, scaling_action_id, reason, performed_at, performed_by ]
      properties:
        id:
          type: int
        scaling_action_id: { type: int }
        reason: { type: string }
        performed_at:
          type: string
          format: date-time
        performed_by: { type: int }

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
    
    ScalingPlan:
      type: object
      properties:
        id: { type: integer }
        task: { type: integer, description: "ID of the parent Task (type=scaling)" }
        strategy:
          type: string
          enum: [ horizontal, vertical, hybrid ]
        scaling_target: { type: string }
        risk_considerations: { type: string }
        max_scaling_limit: { type: string }
        stop_conditions: { type: string }
        affected_entities:
          type: [array, "null"]
          items:
            type: object
        expected_outcomes: { type: string }
        status:
          type: string
          enum: [ planned, in_progress, completed, cancelled ]
        started_at: { type: [string, "null"], format: date-time }
        completed_at: { type: [string, "null"], format: date-time }
        review_summary: { type: string }
        review_lessons_learned: { type: string }
        review_future_actions: { type: string }
        review_completed_at: { type: [string, "null"], format: date-time }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
        steps:
          type: array
          items:
            $ref: '#/components/schemas/ScalingStep'

    ScalingPlanCreate:
      type: object
      required: [ task, strategy ]
      properties:
        task:
          type: integer
          description: "ID of the parent Task (must be type=scaling)"
        strategy:
          type: string
          enum: [ horizontal, vertical, hybrid ]
        scaling_target: { type: string }
        risk_considerations: { type: string }
        max_scaling_limit: { type: string }
        stop_conditions: { type: string }
        affected_entities:
          type: [array, "null"]
          items:
            type: object
        expected_outcomes: { type: string }

    ScalingPlanUpdate:
      type: object
      properties:
        strategy:
          type: string
          enum: [ horizontal, vertical, hybrid ]
        scaling_target: { type: string }
        risk_considerations: { type: string }
        max_scaling_limit: { type: string }
        stop_conditions: { type: string }
        affected_entities:
          type: [array, "null"]
          items:
            type: object
        expected_outcomes: { type: string }
        status:
          type: string
          enum: [ planned, in_progress, completed, cancelled ]
        started_at: { type: [string, "null"], format: date-time }
        completed_at: { type: [string, "null"], format: date-time }
        review_summary: { type: string }
        review_lessons_learned: { type: string }
        review_future_actions: { type: string }
        review_completed_at: { type: [string, "null"], format: date-time }

    ScalingStep:
      type: object
      properties:
        id: { type: integer }
        plan: { type: integer, description: "ID of the parent ScalingPlan" }
        step_order: { type: integer }
        name: { type: string }
        planned_change: { type: string }
        expected_metrics:
          type: [object, "null"]
        actual_metrics:
          type: [object, "null"]
        status:
          type: string
          enum: [ planned, in_progress, completed, cancelled ]
        scheduled_at: { type: [string, "null"], format: date-time }
        executed_at: { type: [string, "null"], format: date-time }
        notes: { type: string }
        stop_triggered: { type: boolean }
        related_scaling_action:
          type: [integer, "null"]
          description: "Optional link to low-level ScalingAction"
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    ScalingStepCreate:
      type: object
      required: [ step_order, status ]
      properties:
        step_order: { type: integer }
        name: { type: string }
        planned_change: { type: string }
        expected_metrics:
          type: [object, "null"]
        status:
          type: string
          enum: [ planned, in_progress, completed, cancelled ]
        scheduled_at: { type: [string, "null"], format: date-time }
        notes: { type: string }
        related_scaling_action:
          type: [integer, "null"]

    ScalingStepUpdate:
      type: object
      properties:
        step_order: { type: integer }
        name: { type: string }
        planned_change: { type: string }
        expected_metrics:
          type: [object, "null"]
        actual_metrics:
          type: [object, "null"]
        status:
          type: string
          enum: [ planned, in_progress, completed, cancelled ]
        scheduled_at: { type: [string, "null"], format: date-time }
        executed_at: { type: [string, "null"], format: date-time }
        notes: { type: string }
        stop_triggered: { type: boolean }
        related_scaling_action:
          type: [integer, "null"]
