openapi: 3.0.3
info:
  title: MediaJira Decision Module API
  version: 0.2.0
  description: 'Backend–frontend contract for the Decision Module.


    Design principles (from URS + SRS):
    - Decision is a record of human judgment, not performance data.
    - Drafts are editable. Committed decisions are read-only for core fields.
    - Commit is an explicit, irreversible action that locks core fields.
    - Reviews are append-only and never mutate the original committed content.
    - State transitions are guarded by the API and surfaced via explicit, machine-readable
    errors.

    '
servers:
- url: /api
tags:
- name: DecisionDrafts
  description: Draft creation and mutation endpoints (editable).
- name: Decisions
  description: Read-only retrieval and discovery of decisions across the user's workspace.
- name: DecisionSignals
  description: Structured signal CRUD for draft decisions.
- name: DecisionCommit
  description: Commit action (state transition).
- name: DecisionReviews
  description: Post-execution reviews (append-only).
- name: DecisionAdmin
  description: Admin/Lead lifecycle actions (e.g., approve, archive).
security:
- bearerAuth: []
paths:
  /decisions/drafts:
    post:
      tags:
      - DecisionDrafts
      summary: Create a new Decision Draft
      description: 'Creates a Decision in DRAFT status with minimal friction.

        This endpoint MUST NOT trigger any execution behavior.

        State transition:

        - (none) -> DRAFT

        Relationship constraints:
        - parentDecisionIds must belong to the same project.
        - Duplicate parentDecisionIds are rejected.
        - Cycles are rejected.

        '
      operationId: createDecisionDraft
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDecisionDraftRequest'
            examples:
              minimal:
                summary: Minimal create (recommended)
                value:
                  title: Optional short title
      responses:
        '201':
          description: Draft created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DecisionDraft'
              examples:
                created:
                  value:
                    id: 2b8c8b1a-4f90-4bb0-93c5-1de3cdb9c2aa
                    title: Optional short title
                    contextSummary: null
                    signals: []
                    options: []
                    reasoning: null
                    riskLevel: null
                    confidenceScore: null
                    status: DRAFT
                    createdAt: '2026-01-20T01:02:03Z'
                    createdBy: f8d2c5b5-1a42-4db3-8e0d-f4c0b1e2a333
                    lastEditedAt: null
                    lastEditedBy: null
                    commitRecord: null
                    permissions:
                      canView: true
                      canEditDraft: true
                      canCommit: true
                      canAddReview: false
                      canApprove: false
                      canArchive: false
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '400':
          $ref: '#/components/responses/ValidationError'
  /decisions/drafts/{decisionId}:
    get:
      tags:
      - DecisionDrafts
      summary: Get a Decision Draft (editable view)
      description: 'Returns a Decision Draft for editing.


        State constraints:

        - Allowed: DRAFT, AWAITING_APPROVAL

        - Rejected: COMMITTED, REVIEWED, ARCHIVED (use GET /decisions/{decisionId})

        '
      operationId: getDecisionDraft
      parameters:
      - $ref: '#/components/parameters/DecisionId'
      responses:
        '200':
          description: Draft found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DecisionDraft'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/InvalidState'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  /core/projects/{project_id}/decisions/graph/:
    get:
      tags:
      - Decisions
      summary: Get decision graph for a project
      description: 'Returns a DAG graph of decisions for the project.'
      operationId: getProjectDecisionGraph
      parameters:
      - name: project_id
        in: path
        required: true
        schema:
          type: integer
          format: int64
      responses:
        '200':
          description: Decision graph
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DecisionGraph'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      tags:
      - DecisionDrafts
      summary: Update a Decision Draft (context/signals/options/reasoning/risk/confidence)
      description: "Partially updates an editable Decision Draft.\nMUST be rejected\
        \ if the decision is COMMITTED/REVIEWED/ARCHIVED.\n\nState constraints:\n\
        - Allowed: DRAFT, AWAITING_APPROVAL\n- Rejected: COMMITTED, REVIEWED, ARCHIVED\n\
        \nNotes on array updates (contract choice):\n- `signals` and `options` arrays\
        \ use full replacement to keep the frontend contract unambiguous.\n  The client\
        \ sends the complete current list.\n\nRelationship constraints:\n- parentDecisionIds must belong to the same project.\n- Duplicate parentDecisionIds are rejected.\n- Cycles are rejected.\n"
      operationId: updateDecisionDraft
      parameters:
      - $ref: '#/components/parameters/DecisionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateDecisionDraftRequest'
            examples:
              updateDraft:
                value:
                  title: Scale after client request
                  contextSummary: Client requested aggressive scaling ahead of promo.
                  signals:
                  - type: CLIENT
                    description: Client requested aggressive scaling
                    severity: MEDIUM
                    source: Email
                  options:
                  - text: Increase budget 20% across top ad sets
                    isSelected: true
                  - text: Hold spend and monitor for 24h
                    isSelected: false
                  reasoning: We have enough headroom and promo window is short.
                  riskLevel: MEDIUM
                  confidenceScore: 3
      responses:
        '200':
          description: Draft updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DecisionDraft'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/InvalidState'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  /decisions/{decisionId}/commit:
    post:
      tags:
      - DecisionCommit
      summary: Commit a Decision (Draft -> Committed or Awaiting Approval)
      description: 'Commits a Decision Draft, recording accountability and locking
        core fields.


        Validations (user-facing):

        - contextSummary non-empty

        - >= 1 signal

        - >= 2 options

        - exactly 1 option selected

        - reasoning non-empty

        - riskLevel set

        - confidenceScore set


        State transition:

        - DRAFT -> COMMITTED (if no approval needed)

        - DRAFT -> AWAITING_APPROVAL (if high-risk approval policy applies)


        Immutability guarantee after COMMITTED:

        - Core fields become read-only: contextSummary, signals, options, reasoning,
        riskLevel, confidenceScore

        - Only reviews (append-only) and admin lifecycle actions are allowed.


        When approval is required:

        - The API returns 200 with status=AWAITING_APPROVAL (not an error).

        - A Lead/Admin must call POST /decisions/{decisionId}/approve to finalize
        the commit.

        '
      operationId: commitDecision
      parameters:
      - $ref: '#/components/parameters/DecisionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommitDecisionRequest'
            examples:
              commit:
                value:
                  note: Ready to commit
      responses:
        '200':
          description: Commit accepted; status indicates COMMITTED or AWAITING_APPROVAL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommitDecisionResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/InvalidState'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  /decisions/{decisionId}/approve:
    post:
      tags:
      - DecisionAdmin
      summary: Approve a pending decision commit (Lead/Admin)
      description: 'Approves a decision that is pending approval.


        State constraints:

        - Allowed: AWAITING_APPROVAL

        - Rejected: DRAFT, COMMITTED, REVIEWED, ARCHIVED


        State transition:

        - AWAITING_APPROVAL -> COMMITTED

        '
      operationId: approveDecision
      parameters:
      - $ref: '#/components/parameters/DecisionId'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApproveDecisionRequest'
      responses:
        '200':
          description: Approved and committed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionDecisionResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/InvalidState'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  /decisions:
    get:
      tags:
      - Decisions
      summary: List decisions in workspace
      description: 'Returns decisions across all projects where the requester is an
        active member.

        Visibility rules:
        - Non-draft decisions are visible to all members of the project.
        - Draft decisions (DRAFT) are only visible to the creator.

        Consumers SHOULD treat returned decisions as read-only records.


        Search:

        - Keyword search across contextSummary, signals.description, options.text,
        reasoning


        Filtering:

        - status, riskLevel, creatorId, date range

        '
      operationId: listDecisions
      parameters:
      - $ref: '#/components/parameters/Status'
      - $ref: '#/components/parameters/RiskLevel'
      - $ref: '#/components/parameters/CreatorId'
      - $ref: '#/components/parameters/DateFrom'
      - $ref: '#/components/parameters/DateTo'
      - $ref: '#/components/parameters/Search'
      - $ref: '#/components/parameters/PageSize'
      - $ref: '#/components/parameters/PageToken'
      responses:
        '200':
          description: Decision list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DecisionListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  /decisions/{decisionId}:
    get:
      tags:
      - Decisions
      summary: Get a decision (read-only view for committed decisions)
      description: 'Retrieves a decision for read-only viewing.

        Intended for COMMITTED/REVIEWED/ARCHIVED decisions.


        If the client needs an editable draft, use GET /decisions/drafts/{decisionId}.


        State constraints:

        - Allowed: COMMITTED, REVIEWED, ARCHIVED

        - Rejected: DRAFT, AWAITING_APPROVAL (use drafts endpoint)

        '
      operationId: getCommittedDecision
      parameters:
      - $ref: '#/components/parameters/DecisionId'
      responses:
        '200':
          description: Decision found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DecisionCommitted'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/InvalidState'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    delete:
      tags:
      - DecisionAdmin
      summary: Soft-delete a decision
      description: 'Soft-deletes a decision by setting is_deleted=True. The decision will be hidden from default queries but remains in the database for audit purposes.

        Allowed for any status (DRAFT, AWAITING_APPROVAL, COMMITTED, REVIEWED, ARCHIVED).

        '
      operationId: deleteDecision
      parameters:
      - $ref: '#/components/parameters/DecisionId'
      responses:
        '204':
          description: Decision deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  /decisions/{decisionId}/reviews:
    get:
      tags:
      - DecisionReviews
      summary: List reviews for a decision
      description: 'Returns review entries appended to a decision.

        Reviews are append-only and do not mutate original decision content.

        '
      operationId: listDecisionReviews
      parameters:
      - $ref: '#/components/parameters/DecisionId'
      responses:
        '200':
          description: Reviews list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewListResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  /decisions/{decisionId}/signals:
    get:
      tags:
      - DecisionSignals
      summary: List signals for a decision
      description: 'Returns signals for a decision.

        Signals are read-only for non-draft decisions.

        '
      operationId: listDecisionSignals
      parameters:
      - $ref: '#/components/parameters/DecisionId'
      responses:
        '200':
          description: Signal list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignalListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    post:
      tags:
      - DecisionSignals
      summary: Create a signal (draft-only)
      description: 'Creates a structured signal for a decision draft.

        Validation rules:
        - Editable only when Decision.status == DRAFT and requester is the creator.
        - Max 15 signals per decision.
        - scopeValue required only when scopeType == CHANNEL.
        - If deltaValue is present, deltaUnit is required (and vice versa).
        - displayText is server-generated unless displayTextOverride is provided.

        '
      operationId: createDecisionSignal
      parameters:
      - $ref: '#/components/parameters/DecisionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignalCreateRequest'
      responses:
        '201':
          description: Signal created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignalResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/InvalidState'
  /decisions/{decisionId}/signals/{signalId}:
    patch:
      tags:
      - DecisionSignals
      summary: Update a signal (draft-only)
      description: 'Updates a structured signal for a decision draft.

        Validation rules:
        - Editable only when Decision.status == DRAFT and requester is the creator.
        - Max 15 signals per decision.
        - scopeValue required only when scopeType == CHANNEL.
        - If deltaValue is present, deltaUnit is required (and vice versa).
        - If displayTextOverride is set, server will use it and freeze auto-generation.

        '
      operationId: updateDecisionSignal
      parameters:
      - $ref: '#/components/parameters/DecisionId'
      - $ref: '#/components/parameters/SignalId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignalCreateRequest'
      responses:
        '200':
          description: Signal updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignalResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/InvalidState'
    delete:
      tags:
      - DecisionSignals
      summary: Delete a signal (draft-only)
      description: 'Deletes a structured signal for a decision draft.

        Editable only when Decision.status == DRAFT and requester is the creator.

        '
      operationId: deleteDecisionSignal
      parameters:
      - $ref: '#/components/parameters/DecisionId'
      - $ref: '#/components/parameters/SignalId'
      responses:
        '204':
          description: Signal deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/InvalidState'
    post:
      tags:
      - DecisionReviews
      summary: Submit a review (append-only)
      description: "Adds a post-execution review entry to a decision.\n\nState constraints:\n\
        - Allowed: COMMITTED, REVIEWED\n- Rejected: DRAFT, AWAITING_APPROVAL, ARCHIVED\n\
        \nState transition:\n- First review MUST transition COMMITTED -> REVIEWED\n\
        - Subsequent reviews on REVIEWED do not change status\n"
      operationId: addDecisionReview
      parameters:
      - $ref: '#/components/parameters/DecisionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateReviewRequest'
            examples:
              review:
                value:
                  outcomeText: CPA stabilized after 72h.
                  reflectionText: Budget reduction helped; next time test new creative
                    sooner.
                  decisionQuality: GOOD
                  tags:
                  - budget
                  - creative
      responses:
        '201':
          description: Review created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionDecisionResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/InvalidState'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  /decisions/{decisionId}/archive:
    post:
      tags:
      - DecisionAdmin
      summary: Archive a decision (Admin only)
      description: 'Archives a decision. Archived decisions are read-only and can
        be hidden from default lists.


        State transition:

        - ANY -> ARCHIVED

        '
      operationId: archiveDecision
      parameters:
      - $ref: '#/components/parameters/DecisionId'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ArchiveDecisionRequest'
      responses:
        '200':
          description: Archived
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionDecisionResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/InvalidState'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    DecisionId:
      name: decisionId
      in: path
      required: true
      schema:
        type: integer
        format: int64
    SignalId:
      name: signalId
      in: path
      required: true
      schema:
        type: integer
        format: int64
    Status:
      name: status
      in: query
      required: false
      description: Filter by decision status.
      schema:
        $ref: '#/components/schemas/DecisionStatus'
    RiskLevel:
      name: riskLevel
      in: query
      required: false
      schema:
        $ref: '#/components/schemas/RiskLevel'
    CreatorId:
      name: creatorId
      in: query
      required: false
      schema:
        type: integer
        format: int64
    DateFrom:
      name: from
      in: query
      required: false
      description: Inclusive start date/time (ISO-8601).
      schema:
        type: string
        format: date-time
    DateTo:
      name: to
      in: query
      required: false
      description: Exclusive end date/time (ISO-8601).
      schema:
        type: string
        format: date-time
    Search:
      name: q
      in: query
      required: false
      description: Keyword search across contextSummary, signals.description, options.text,
        reasoning.
      schema:
        type: string
        maxLength: 200
    PageSize:
      name: pageSize
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
    PageToken:
      name: pageToken
      in: query
      required: false
      schema:
        type: string
  responses:
    Unauthorized:
      description: Authentication required.
      content:
        application/json:
          schema:
            oneOf:
            - $ref: '#/components/schemas/ErrorResponse'
            - $ref: '#/components/schemas/DRFDetailError'
          example:
            errorCode: UNAUTHORIZED
            message: Authentication required.
    Forbidden:
      description: Caller does not have permission.
      content:
        application/json:
          schema:
            oneOf:
            - $ref: '#/components/schemas/ErrorResponse'
            - $ref: '#/components/schemas/DRFDetailError'
          example:
            errorCode: FORBIDDEN
            message: You do not have permission to perform this action.
    NotFound:
      description: Resource not found.
      content:
        application/json:
          schema:
            oneOf:
            - $ref: '#/components/schemas/ErrorResponse'
            - $ref: '#/components/schemas/DRFDetailError'
          example:
            errorCode: NOT_FOUND
            message: Decision not found.
    ValidationError:
      description: 'Request failed validation. Frontend can show field-level errors.


        Field error keys are standardized for UI mapping (commit + draft validation):

        - title

        - contextSummary

        - signals

        - options

        - selectedOption

        - reasoning

        - riskLevel

        - confidenceScore

        - confirmationStatements

        '
      content:
        application/json:
          schema:
            oneOf:
            - $ref: '#/components/schemas/ValidationErrorResponse'
            - $ref: '#/components/schemas/DRFValidationError'
          example:
            errorCode: VALIDATION_ERROR
            message: Please fix the highlighted fields.
            fieldErrors:
              contextSummary:
              - Context Summary is required before commit.
              signals:
              - Please add at least one Signal describing what triggered this decision.
              options:
              - Please add at least two options.
              selectedOption:
              - Select exactly one option before committing.
              reasoning:
              - Reasoning is required before commit.
              riskLevel:
              - Please select a risk level (Low/Medium/High).
              confidenceScore:
              - Please select a confidence score (1–5).
              confirmationStatements:
              - All confirmation statements must be accepted to commit.
    InvalidState:
      description: Invalid state transition or operation not allowed in current status.
      content:
        application/json:
          schema:
            oneOf:
            - $ref: '#/components/schemas/InvalidStateErrorResponse'
            - $ref: '#/components/schemas/DRFDetailError'
          examples:
            committedCannotEdit:
              summary: Attempt to edit draft after commit
              value:
                errorCode: INVALID_STATE_TRANSITION
                message: This operation is not allowed in the current state.
                details:
                  currentStatus: COMMITTED
                  allowedStatuses:
                  - DRAFT
                  - AWAITING_APPROVAL
                  suggestedAction: Use GET /decisions/{decisionId} for read-only view.
            draftCannotReadCommittedEndpoint:
              summary: Attempt to read draft from committed endpoint
              value:
                errorCode: INVALID_STATE_TRANSITION
                message: This operation is not allowed in the current state.
                details:
                  currentStatus: DRAFT
                  allowedStatuses:
                  - COMMITTED
                  - REVIEWED
                  - ARCHIVED
                  suggestedAction: Use GET /decisions/drafts/{decisionId} for editable
                    view.
  schemas:
    DecisionStatus:
      type: string
      description: 'Decision lifecycle status.


        Primary states:

        - DRAFT: editable

        - AWAITING_APPROVAL: commit accepted but pending Lead/Admin approval

        - COMMITTED: core fields locked, read-only

        - REVIEWED: at least one review exists (explicit or derived)

        - ARCHIVED: hidden/read-only terminal state

        '
      enum:
      - DRAFT
      - AWAITING_APPROVAL
      - COMMITTED
      - REVIEWED
      - ARCHIVED
    RiskLevel:
      type: string
      enum:
      - LOW
      - MEDIUM
      - HIGH
    ConfidenceScore:
      type: integer
      minimum: 1
      maximum: 5
    SignalType:
      type: string
      description: Common signal categories; teams may extend.
      enum:
      - PERFORMANCE
      - CLIENT
      - PLATFORM
      - INTUITION
      - OTHER
    SignalSeverity:
      type: string
      enum:
      - LOW
      - MEDIUM
      - HIGH
    SignalMetric:
      type: string
      enum:
      - ROAS
      - CPA
      - CONVERSION_RATE
      - REVENUE
      - PURCHASES
      - CTR
      - CLICKS
      - IMPRESSIONS
      - CPC
      - CPM
      - AD_SPEND
      - AOV
    SignalMovement:
      type: string
      enum:
      - SHARP_INCREASE
      - MODERATE_INCREASE
      - SLIGHT_INCREASE
      - NO_SIGNIFICANT_CHANGE
      - SLIGHT_DECREASE
      - MODERATE_DECREASE
      - SHARP_DECREASE
      - VOLATILE
      - UNEXPECTED_SPIKE
      - UNEXPECTED_DROP
    SignalPeriod:
      type: string
      enum:
      - LAST_24_HOURS
      - LAST_3_DAYS
      - LAST_7_DAYS
      - LAST_14_DAYS
      - LAST_30_DAYS
    SignalComparison:
      type: string
      enum:
      - NONE
      - PREVIOUS_PERIOD
      - SAME_PERIOD_LAST_WEEK
      - SINCE_LAUNCH
    SignalScopeType:
      type: string
      enum:
      - CAMPAIGN
      - AD_SET
      - AD
      - CHANNEL
      - AUDIENCE
      - REGION
    SignalDeltaUnit:
      type: string
      enum:
      - PERCENT
      - CURRENCY
      - ABSOLUTE
    DecisionQuality:
      type: string
      enum:
      - GOOD
      - ACCEPTABLE
      - POOR
    DecisionPermissions:
      type: object
      description: 'Server-computed permissions for the current caller.

        Frontend should use these to show/enable actions without guessing role logic.

        '
      required:
      - canView
      - canEditDraft
      - canCommit
      - canAddReview
      - canApprove
      - canArchive
      properties:
        canView:
          type: boolean
        canEditDraft:
          type: boolean
        canCommit:
          type: boolean
        canAddReview:
          type: boolean
        canApprove:
          type: boolean
        canArchive:
          type: boolean
    DecisionCore:
      type: object
      required:
      - id
      - projectSeq
      - status
      - createdAt
      - createdBy
      properties:
        id:
          type: integer
          format: int64
        projectSeq:
          type: integer
          format: int64
        title:
          type: string
          maxLength: 120
          nullable: true
        contextSummary:
          type: string
          maxLength: 5000
          nullable: true
        signals:
          type: array
          items:
            $ref: '#/components/schemas/Signal'
          default: []
        options:
          type: array
          items:
            $ref: '#/components/schemas/Option'
          default: []
        reasoning:
          type: string
          maxLength: 8000
          nullable: true
        riskLevel:
          $ref: '#/components/schemas/RiskLevel'
          nullable: true
        confidenceScore:
          $ref: '#/components/schemas/ConfidenceScore'
          nullable: true
        status:
          $ref: '#/components/schemas/DecisionStatus'
        createdAt:
          type: string
          format: date-time
          readOnly: true
        createdBy:
          type: integer
          format: int64
        lastEditedAt:
          type: string
          format: date-time
          readOnly: true
          nullable: true
        lastEditedBy:
          type: integer
          format: int64
        permissions:
          $ref: '#/components/schemas/DecisionPermissions'
          readOnly: true
    DecisionDraft:
      allOf:
      - $ref: '#/components/schemas/DecisionCore'
      - type: object
        description: 'Editable decision representation.

          Only available via /decisions/drafts endpoints.

          '
        properties:
          commitRecord:
            nullable: true
            readOnly: true
            allOf:
            - $ref: '#/components/schemas/CommitRecord'
    DecisionCommitted:
      allOf:
      - $ref: '#/components/schemas/DecisionCore'
      - type: object
        description: 'Read-only decision representation for committed states.


          Immutability:

          - contextSummary, signals, options, reasoning, riskLevel, confidenceScore
          are locked after commit.

          - Updates MUST be rejected via draft mutation endpoints once committed.


          Reviews are append-only and returned alongside.

          '
        required:
        - commitRecord
        properties:
          committedAt:
            type: string
            format: date-time
            readOnly: true
            nullable: true
          committedBy:
            type: integer
            format: int64
          commitRecord:
            $ref: '#/components/schemas/CommitRecord'
          reviews:
            type: array
            items:
              $ref: '#/components/schemas/Review'
            readOnly: true
            default: []
    Signal:
      type: object
      required:
      - type
      - description
      properties:
        id:
          type: integer
          format: int64
        type:
          $ref: '#/components/schemas/SignalType'
        description:
          type: string
          maxLength: 2000
        severity:
          $ref: '#/components/schemas/SignalSeverity'
        source:
          type: string
          maxLength: 200
          nullable: true
    SignalCreateRequest:
      type: object
      additionalProperties: false
      required:
      - metric
      - movement
      - period
      description: 'Structured signal create/update payload.

        Validation rules:
        - scopeValue required only when scopeType == CHANNEL.
        - If deltaValue is present, deltaUnit is required (and vice versa).
        - displayText is generated server-side unless displayTextOverride is provided.

        '
      properties:
        metric:
          $ref: '#/components/schemas/SignalMetric'
        movement:
          $ref: '#/components/schemas/SignalMovement'
        period:
          $ref: '#/components/schemas/SignalPeriod'
        comparison:
          $ref: '#/components/schemas/SignalComparison'
          default: NONE
        scopeType:
          $ref: '#/components/schemas/SignalScopeType'
          nullable: true
        scopeValue:
          type: string
          nullable: true
        deltaValue:
          type: number
          nullable: true
        deltaUnit:
          $ref: '#/components/schemas/SignalDeltaUnit'
          nullable: true
        displayTextOverride:
          type: string
          nullable: true
    SignalResponse:
      type: object
      required:
      - id
      - decisionId
      - createdBy
      - createdAt
      - updatedAt
      - metric
      - movement
      - period
      - comparison
      properties:
        id:
          type: integer
          format: int64
        decisionId:
          type: integer
          format: int64
        createdBy:
          type: integer
          format: int64
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        metric:
          $ref: '#/components/schemas/SignalMetric'
        movement:
          $ref: '#/components/schemas/SignalMovement'
        period:
          $ref: '#/components/schemas/SignalPeriod'
        comparison:
          $ref: '#/components/schemas/SignalComparison'
        scopeType:
          $ref: '#/components/schemas/SignalScopeType'
          nullable: true
        scopeValue:
          type: string
          nullable: true
        deltaValue:
          type: number
          nullable: true
        deltaUnit:
          $ref: '#/components/schemas/SignalDeltaUnit'
          nullable: true
        displayText:
          type: string
        displayTextOverride:
          type: string
          nullable: true
    SignalListResponse:
      type: object
      required:
      - items
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/SignalResponse'
    Option:
      type: object
      required:
      - text
      - isSelected
      properties:
        id:
          type: integer
          format: int64
        text:
          type: string
          maxLength: 2000
        isSelected:
          type: boolean
          description: Exactly one option must be selected before commit.
    DecisionEdge:
      type: object
      required:
      - from
      - to
      properties:
        from:
          type: integer
          format: int64
        to:
          type: integer
          format: int64
    DecisionGraphNode:
      type: object
      required:
      - id
      - projectSeq
      - status
      - createdAt
      - updatedAt
      properties:
        id:
          type: integer
          format: int64
        projectSeq:
          type: integer
          format: int64
        title:
          type: string
          nullable: true
        status:
          type: string
        riskLevel:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        projectId:
          type: integer
          format: int64
    DecisionGraph:
      type: object
      required:
      - nodes
      - edges
      properties:
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/DecisionGraphNode'
        edges:
          type: array
          items:
            $ref: '#/components/schemas/DecisionEdge'
    DecisionConnectionsUpdateRequest:
      type: object
      required:
      - connectedDecisionSeqs
      properties:
        connectedDecisionSeqs:
          type: array
          items:
            type: integer
            format: int64
    DecisionConnectionSelf:
      type: object
      required:
      - id
      - project_seq
      properties:
        id:
          type: integer
          format: int64
        project_seq:
          type: integer
          format: int64
    DecisionConnectionItem:
      type: object
      required:
      - id
      - project_seq
      - title
      properties:
        id:
          type: integer
          format: int64
        project_seq:
          type: integer
          format: int64
        title:
          type: string
          nullable: true
    DecisionConnectionEdge:
      type: object
      required:
      - from_seq
      - to_seq
      properties:
        from_seq:
          type: integer
          format: int64
        to_seq:
          type: integer
          format: int64
    DecisionConnectionsResponse:
      type: object
      required:
      - self
      - connected
      properties:
        self:
          $ref: '#/components/schemas/DecisionConnectionSelf'
        connected:
          type: array
          items:
            $ref: '#/components/schemas/DecisionConnectionItem'
        edges:
          type: array
          items:
            $ref: '#/components/schemas/DecisionConnectionEdge'
    CreateDecisionDraftRequest:
      type: object
      additionalProperties: false
      properties:
        title:
          type: string
          maxLength: 120
          nullable: true
        parentDecisionIds:
          type: array
          items:
            type: integer
            format: int64
    UpdateDecisionDraftRequest:
      type: object
      additionalProperties: false
      description: 'Partial update payload for draft edits.

        Fields omitted are left unchanged.


        Note:

        - `signals` and `options` are full-replacement arrays when present.

        '
      properties:
        title:
          type: string
          maxLength: 120
          nullable: true
        parentDecisionIds:
          type: array
          items:
            type: integer
            format: int64
          description: Replaces existing parent edges when provided.
        contextSummary:
          type: string
          maxLength: 5000
          nullable: true
        signals:
          type: array
          items:
            $ref: '#/components/schemas/Signal'
        options:
          type: array
          items:
            $ref: '#/components/schemas/Option'
        reasoning:
          type: string
          maxLength: 8000
          nullable: true
        riskLevel:
          $ref: '#/components/schemas/RiskLevel'
          nullable: true
        confidenceScore:
          $ref: '#/components/schemas/ConfidenceScore'
          nullable: true
    CommitDecisionRequest:
      type: object
      properties:
        note:
          type: string
          nullable: true
        validation_snapshot:
          type: object
          nullable: true
        metadata:
          type: object
          nullable: true
    ApproveDecisionRequest:
      type: object
      properties:
        note:
          type: string
          nullable: true
        metadata:
          type: object
          nullable: true
    ArchiveDecisionRequest:
      type: object
      properties:
        note:
          type: string
          nullable: true
        metadata:
          type: object
          nullable: true
    CommitRecord:
      type: object
      description: 'Commit metadata recorded when decision becomes official.


        Implementation note: the server may persist commit validations/confirmations
        as a JSON snapshot.'
      required:
      - timestamp
      - userId
      - confirmationStatements
      properties:
        timestamp:
          type: string
          format: date-time
          readOnly: true
        userId:
          type: integer
          format: int64
        confirmationStatements:
          type: object
          required:
          - consideredAlternatives
          - acceptRisk
          - willReviewOutcome
          properties:
            consideredAlternatives:
              type: boolean
            acceptRisk:
              type: boolean
            willReviewOutcome:
              type: boolean
    CommitDecisionResponse:
      type: object
      required:
      - detail
      - status
      properties:
        detail:
          type: string
        status:
          type: string
          enum:
          - COMMITTED
          - AWAITING_APPROVAL
        next_action:
          type: string
          nullable: true
          enum:
          - APPROVE
        decision:
          $ref: '#/components/schemas/DecisionDetail'
    ActionDecisionResponse:
      type: object
      required:
      - detail
      - status
      properties:
        detail:
          type: string
        status:
          $ref: '#/components/schemas/DecisionStatus'
        next_action:
          type: string
          nullable: true
          enum:
          - APPROVE
        decision:
          $ref: '#/components/schemas/DecisionDetail'
    DecisionSignal:
      type: object
      properties:
        id:
          type: integer
          format: int64
        decision:
          type: integer
          format: int64
        type:
          type: string
        description:
          type: string
        severity:
          type: string
          nullable: true
        source:
          type: string
          nullable: true
        order:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        is_deleted:
          type: boolean
    DecisionOption:
      type: object
      properties:
        id:
          type: integer
          format: int64
        decision:
          type: integer
          format: int64
        text:
          type: string
        is_selected:
          type: boolean
        order:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        is_deleted:
          type: boolean
    DecisionReview:
      type: object
      properties:
        id:
          type: integer
          format: int64
        decision:
          type: integer
          format: int64
        reviewer:
          type: integer
          format: int64
          nullable: true
        outcome_text:
          type: string
        reflection_text:
          type: string
        quality:
          type: string
        reviewed_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        is_deleted:
          type: boolean
    DecisionCommitRecord:
      type: object
      properties:
        id:
          type: integer
          format: int64
        decision:
          type: integer
          format: int64
        committed_by:
          type: integer
          format: int64
          nullable: true
        committed_at:
          type: string
          format: date-time
        validation_snapshot:
          type: object
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        is_deleted:
          type: boolean
    DecisionStateTransition:
      type: object
      properties:
        id:
          type: integer
          format: int64
        decision:
          type: integer
          format: int64
        from_status:
          $ref: '#/components/schemas/DecisionStatus'
        to_status:
          $ref: '#/components/schemas/DecisionStatus'
        transition_method:
          type: string
        metadata:
          type: object
          nullable: true
        triggered_by:
          type: integer
          format: int64
          nullable: true
        timestamp:
          type: string
          format: date-time
        note:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        is_deleted:
          type: boolean
    DecisionDetail:
      type: object
      properties:
        id:
          type: integer
          format: int64
        title:
          type: string
          nullable: true
        context_summary:
          type: string
          nullable: true
        reasoning:
          type: string
          nullable: true
        risk_level:
          $ref: '#/components/schemas/RiskLevel'
          nullable: true
        confidence:
          type: integer
          nullable: true
        status:
          $ref: '#/components/schemas/DecisionStatus'
        requires_approval:
          type: boolean
        committed_at:
          type: string
          format: date-time
          nullable: true
        approved_at:
          type: string
          format: date-time
          nullable: true
        is_reference_case:
          type: boolean
        author:
          type: integer
          format: int64
          nullable: true
        last_edited_by:
          type: integer
          format: int64
          nullable: true
        committed_by:
          type: integer
          format: int64
          nullable: true
        approved_by:
          type: integer
          format: int64
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        is_deleted:
          type: boolean
        signals:
          type: array
          items:
            $ref: '#/components/schemas/DecisionSignal'
        options:
          type: array
          items:
            $ref: '#/components/schemas/DecisionOption'
        reviews:
          type: array
          items:
            $ref: '#/components/schemas/DecisionReview'
        commit_record:
          $ref: '#/components/schemas/DecisionCommitRecord'
          nullable: true
        state_transitions:
          type: array
          items:
            $ref: '#/components/schemas/DecisionStateTransition'
    CreateReviewRequest:
      type: object
      additionalProperties: false
      required:
      - outcomeText
      - reflectionText
      - decisionQuality
      properties:
        outcomeText:
          type: string
          maxLength: 8000
        reflectionText:
          type: string
          maxLength: 8000
        decisionQuality:
          $ref: '#/components/schemas/DecisionQuality'
        tags:
          type: array
          items:
            type: string
            maxLength: 50
          default: []
    Review:
      type: object
      required:
      - outcomeText
      - reflectionText
      - quality
      properties:
        id:
          type: integer
          format: int64
        outcomeText:
          type: string
          maxLength: 4000
        reflectionText:
          type: string
          maxLength: 4000
        quality:
          $ref: '#/components/schemas/DecisionQuality'
        reviewerId:
          type: integer
          format: int64
        reviewedAt:
          type: string
          format: date-time
    DecisionListItem:
      type: object
      required:
      - id
      - projectSeq
      - status
      - title
      - contextSummary
      - riskLevel
      - confidenceScore
      - createdAt
      - createdBy
      properties:
        id:
          type: integer
          format: int64
        projectSeq:
          type: integer
          format: int64
        projectId:
          type: integer
          format: int64
          nullable: true
        projectName:
          type: string
          nullable: true
        status:
          $ref: '#/components/schemas/DecisionStatus'
        title:
          type: string
          nullable: true
        contextSummary:
          type: string
          nullable: true
        selectedOptionText:
          type: string
          nullable: true
          description: Convenience field for list rendering.
        riskLevel:
          $ref: '#/components/schemas/RiskLevel'
          nullable: true
        confidenceScore:
          $ref: '#/components/schemas/ConfidenceScore'
          nullable: true
        createdAt:
          type: string
          format: date-time
        createdBy:
          type: integer
          format: int64
        committedAt:
          type: string
          format: date-time
          nullable: true
        hasReviews:
          type: boolean
          default: false
    DecisionListResponse:
      type: object
      required:
      - items
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/DecisionListItem'
        nextPageToken:
          type: string
          nullable: true
    ReviewListResponse:
      type: object
      required:
      - items
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Review'
    ErrorResponse:
      type: object
      required:
      - errorCode
      - message
      properties:
        errorCode:
          type: string
          description: Stable machine-readable error code.
        message:
          type: string
        details:
          type: object
          additionalProperties: true
        detail:
          type: string
          description: DRF-compatible error message (optional).
      additionalProperties: true
    InvalidStateErrorDetails:
      type: object
      description: 'Standardized details for INVALID_STATE_TRANSITION errors.

        Frontend can use these fields to render helpful messages and guidance.

        '
      required:
      - currentStatus
      - allowedStatuses
      - suggestedAction
      properties:
        currentStatus:
          $ref: '#/components/schemas/DecisionStatus'
        allowedStatuses:
          type: array
          items:
            $ref: '#/components/schemas/DecisionStatus'
        suggestedAction:
          type: string
          maxLength: 500
    InvalidStateErrorResponse:
      allOf:
      - $ref: '#/components/schemas/ErrorResponse'
      - type: object
        required:
        - details
        properties:
          details:
            $ref: '#/components/schemas/InvalidStateErrorDetails'
    ValidationErrorResponse:
      allOf:
      - $ref: '#/components/schemas/ErrorResponse'
      - type: object
        required:
        - fieldErrors
        properties:
          fieldErrors:
            type: object
            additionalProperties:
              type: array
              items:
                type: string
            description: 'Field-level validation errors for UI mapping.


              Standard keys:

              - title

              - contextSummary

              - signals

              - options

              - selectedOption

              - reasoning

              - riskLevel

              - confidenceScore

              - confirmationStatements

              '
    DRFDetailError:
      type: object
      properties:
        detail:
          type: string
          description: DRF default error message.
      required:
      - detail
      additionalProperties: true
    DRFValidationError:
      type: object
      description: 'DRF default validation error shape: field -> [messages].'
      additionalProperties:
        oneOf:
        - type: array
          items:
            type: string
        - type: string
  /decisions/{decisionId}/connections:
    get:
      tags:
      - Decisions
      summary: Get connected decisions for a decision
      description: Returns the set of decisions connected by edges to the specified decision.
      operationId: getDecisionConnections
      parameters:
      - name: decisionId
        in: path
        required: true
        schema:
          type: integer
          format: int64
      responses:
        '200':
          description: Connected decisions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DecisionConnectionsResponse'
        '404':
          description: Decision not found.
    put:
      tags:
      - Decisions
      summary: Set connected decisions by seq list (diff apply)
      description: Replaces the connected decision set by project-scoped seq list.
      operationId: updateDecisionConnections
      parameters:
      - name: decisionId
        in: path
        required: true
        schema:
          type: integer
          format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DecisionConnectionsUpdateRequest'
      responses:
        '200':
          description: Updated connected decisions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DecisionConnectionsResponse'
        '400':
          description: |-
            Invalid request. Reasons include:
            - cycle detected
            - duplicate edge
            - invalid seq / seq not in project
        '404':
          description: Decision not found.
