openapi: 3.0.3
info:
  title: Task API
  version: 1.0.0
servers:
  - url: http://localhost:8000/
paths:
  /tasks:
    get:
      summary: List tasks
      parameters:
        - in: query
          name: type
          schema: { type: string, enum: [budget, asset, retrospective, report, scaling, communication] }
        - in: query
          name: object_id
          schema: { type: string }
        - in: query
          name: content_type
          schema: { type: string }
        - in: query
          name: status
          schema: { type: string }
        - in: query
          name: project_id
          schema: { type: integer }
        - in: query
          name: owner_id
          schema: { type: integer }
      responses:
        "200":
          description: A list of tasks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Task"
    post:
      summary: Create and submit a task
      description: |
        Creates a new task. Requires an active project.
        If project_id is not provided, the user's active project will be used.
        If user has no active project, returns 403 Forbidden.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TaskCreateRequest"
      responses:
        "201":
          description: Task created and submitted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
        "400":
          description: Bad request (missing required fields, invalid project_id, or user not a member of project)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (user has no active project or is not a member of the specified project)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /tasks/{id}:
    get:
      summary: Get a task by ID
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Task details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
    patch:
      summary: Update task details
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TaskUpdateRequest"
      responses:
        "200":
          description: Updated task
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"

  /tasks/{id}/link:
    post:
      summary: Link task to an existing object
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content_type, object_id]
              properties:
                content_type:
                  type: string
                  description: Content type of the object to link (e.g., 'budgetrequest', 'asset', 'retrospectivetask')
                object_id:
                  type: string
                  description: ID of the object to link in string format
      responses:
        "200":
          description: Task successfully linked
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
        "400":
          description: Bad request (task already linked, invalid content type, object not found)

  /tasks/{id}/approval-history:
    get:
      summary: Get task approval history
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Task approval history retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskHistoryResponse"
        "404":
          description: Task not found

  /tasks/{id}/start-review:
    post:
      summary: Start review for a task (change status to UNDER_REVIEW)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Task review started successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
        "400":
          description: Bad request (task not in SUBMITTED status)

  /tasks/{id}/make-approval:
    post:
      summary: Make approval decision (approve or reject) for a task
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [action]
              properties:
                action:
                  type: string
                  enum: [approve, reject]
                  description: The approval action to perform
                comment:
                  type: string
                  description: Optional comment for the approval decision
      responses:
        "200":
          description: Approval decision made successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApprovalRecord"
        "400":
          description: Bad request (task not in UNDER_REVIEW status, invalid action, or missing required fields)

  /tasks/{id}/cancel:
    post:
      summary: Execute cancel transition
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Task cancelled successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskTransitionWithRecordResponse"
        "400":
          description: Bad request (task not in cancellable status)

  /tasks/{id}/lock:
    post:
      summary: Lock a task (change status to LOCKED)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Task locked successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
        "400":
          description: Bad request (task not in APPROVED status)

  /tasks/{id}/revise:
    post:
      summary: Revise a task (change status to DRAFT)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Task status changed to DRAFT successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
        "400":
          description: Bad request (task not in REJECTED or CANCELLED status)

  /tasks/{id}/forward:
    post:
      summary: Forward a task to next approver (update current_approver)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [next_approver_id]
              properties:
                next_approver_id:
                  type: integer
                  description: ID of the new approver user
                comment:
                  type: string
                  description: Optional comment for the forward
      responses:
        "200":
          description: Task forwarded successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
        "400":
          description: Bad request (task not in APPROVED status, invalid next_approver_id, or missing required fields)

  /tasks/{task_id}/attachments:
    get:
      summary: List attachments for a task
      description: Retrieve all attachments for a specific task. Only project members can access.
      parameters:
        - in: path
          name: task_id
          required: true
          schema: { type: integer }
          description: ID of the task
      responses:
        "200":
          description: List of task attachments
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TaskAttachment"
        "403":
          description: Forbidden (user is not a member of the task's project)
        "404":
          description: Task not found
        "401":
          description: Unauthorized
    post:
      summary: Upload an attachment to a task
      description: Upload a file attachment to a task. File will be scanned for viruses automatically.
      parameters:
        - in: path
          name: task_id
          required: true
          schema: { type: integer }
          description: ID of the task
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                  description: File to upload (any file type supported)
            encoding:
              file:
                contentType: "*/*"
      responses:
        "201":
          description: Attachment created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskAttachment"
        "400":
          description: Bad request (file is required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (user is not a member of the task's project)
        "404":
          description: Task not found
        "401":
          description: Unauthorized

  /tasks/{task_id}/attachments/{id}:
    get:
      summary: Get attachment details
      description: Retrieve details of a specific task attachment.
      parameters:
        - in: path
          name: task_id
          required: true
          schema: { type: integer }
          description: ID of the task
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: ID of the attachment
      responses:
        "200":
          description: Attachment details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskAttachment"
        "403":
          description: Forbidden (user is not a member of the task's project)
        "404":
          description: Task or attachment not found
        "401":
          description: Unauthorized
    delete:
      summary: Delete an attachment
      description: Delete a task attachment. Only project members can delete attachments.
      parameters:
        - in: path
          name: task_id
          required: true
          schema: { type: integer }
          description: ID of the task
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: ID of the attachment
      responses:
        "204":
          description: Attachment deleted successfully
        "403":
          description: Forbidden (user is not a member of the task's project)
        "404":
          description: Task or attachment not found
        "401":
          description: Unauthorized

  /tasks/{task_id}/attachments/{id}/download:
    get:
      summary: Get attachment download information
      description: Get download URL and metadata for a task attachment.
      parameters:
        - in: path
          name: task_id
          required: true
          schema: { type: integer }
          description: ID of the task
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: ID of the attachment
      responses:
        "200":
          description: Download information
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskAttachmentDownload"
        "403":
          description: Forbidden (user is not a member of the task's project)
        "404":
          description: Task, attachment not found, or file not available
        "401":
          description: Unauthorized

  /tasks/{id}/subtasks:
    get:
      summary: List all subtasks of a task
      description: Retrieve all subtasks (child tasks) of a parent task. Only project members can access.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: ID of the parent task
      responses:
        "200":
          description: List of subtasks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Task"
        "403":
          description: Forbidden (user is not a member of the task's project)
        "404":
          description: Task not found
        "401":
          description: Unauthorized
    post:
      summary: Add a subtask to a parent task
      description: |
        Add a child task as a subtask of the parent task. 
        Only 1 level of nesting is allowed (subtasks cannot have subtasks).
        Both tasks must be saved and user must have access to both tasks' projects.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: ID of the parent task
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [child_task_id]
              properties:
                child_task_id:
                  type: integer
                  description: ID of the task to add as a subtask
      responses:
        "201":
          description: Subtask added successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
        "400":
          description: Bad request (invalid child_task_id, subtask already has subtasks, circular reference, or self-reference)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (user is not a member of the task's project)
        "404":
          description: Task not found
        "401":
          description: Unauthorized

  /tasks/{id}/subtasks/{subtask_id}:
    delete:
      summary: Remove a subtask relationship
      description: Remove a subtask from a parent task. Only project members can remove subtasks.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: ID of the parent task
        - in: path
          name: subtask_id
          required: true
          schema: { type: integer }
          description: ID of the subtask to remove
      responses:
        "204":
          description: Subtask relationship removed successfully
        "403":
          description: Forbidden (user is not a member of the task's project)
        "404":
          description: Task, subtask, or relationship not found
        "401":
          description: Unauthorized

  /tasks/{id}/relations:
    get:
      summary: Get all task relations
      description: |
        Retrieve all relations for a task, grouped by relationship type.
        Returns both outgoing and incoming relations (e.g., causes/is_caused_by, blocks/is_blocked_by, etc.).
        Only project members can access.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: ID of the task
      responses:
        "200":
          description: Task relations grouped by type
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskRelationsResponse"
        "403":
          description: Forbidden (user is not a member of the task's project)
        "404":
          description: Task not found
        "401":
          description: Unauthorized
    post:
      summary: Add a relation to a task
      description: |
        Add a relationship between the current task (source) and another task (target).
        The relationship is stored in one direction. To add "is caused by", call this endpoint from the cause task's perspective.
        Only project members can add relations.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: ID of the source task (current task)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [target_task_id, relationship_type]
              properties:
                target_task_id:
                  type: integer
                  description: ID of the target task
                relationship_type:
                  type: string
                  enum: [causes, blocks, clones, relates_to]
                  description: |
                    Type of relationship. 
                    - "causes": current task causes target task
                    - "blocks": current task blocks target task
                    - "clones": current task clones target task
                    - "relates_to": current task relates to target task (symmetric)
      responses:
        "201":
          description: Relation added successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskRelationResponse"
        "400":
          description: Bad request (invalid target_task_id, self-reference, or missing required fields)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (user is not a member of the task's project)
        "404":
          description: Task not found
        "401":
          description: Unauthorized

  /tasks/{id}/relations/{relation_id}:
    delete:
      summary: Delete a task relation
      description: Delete a specific relation. Only project members can delete relations.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: ID of the task
        - in: path
          name: relation_id
          required: true
          schema: { type: integer }
          description: ID of the relation to delete
      responses:
        "204":
          description: Relation deleted successfully
        "403":
          description: Forbidden (user is not a member of the task's project or relation does not belong to this task)
        "404":
          description: Task or relation not found
        "401":
          description: Unauthorized

components:
  schemas:
    Task:
      type: object
      properties:
        id: { type: integer }
        summary: { type: string }
        description: { type: string }
        status: { type: string }
        type: { type: string }
        content_type: { type: string }
        object_id: { type: string }
        owner: { $ref: "#/components/schemas/UserSummary" }
        current_approver: { $ref: "#/components/schemas/UserSummary" }
        project: { $ref: "#/components/schemas/ProjectSummary" }
        due_date: { type: string, format: date }

    TaskCreateRequest:
      type: object
      required: [summary, type]
      description: |
        Task creation request. project_id is optional - if not provided, user's active project will be used.
        If user has no active project, project_id becomes required.
      properties:
        summary: { type: string }
        description: { type: string }
        type: { type: string, enum: [budget, asset, retrospective, report, scaling, communication] }
        current_approver_id: { type: integer, nullable: true }
        project_id: 
          type: integer
          nullable: true
          description: "Project ID. If not provided, user's active project will be used."
        due_date: { type: string, format: date, nullable: true }

    TaskUpdateRequest:
      type: object
      properties:
        summary: { type: string }
        description: { type: string }
        current_approver_id: { type: integer }
        project_id: { type: integer }
        due_date: { type: string, format: date }

    TaskHistoryResponse:
      type: object
      properties:
        history:
          type: array
          items:
            $ref: "#/components/schemas/ApprovalRecord"

    ApprovalRecord:
      type: object
      properties:
        id: { type: integer }
        approved_by: { $ref: "#/components/schemas/UserSummary" }
        is_approved: { type: boolean }
        comment: { type: string }
        decided_time: { type: string, format: date-time }
        step_number: { type: integer }

    UserSummary:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        email: { type: string }

    ProjectSummary:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
    
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          example: "Error message"
        detail:
          type: string
          nullable: true
          example: "Additional error details"

    TaskAttachment:
      type: object
      properties:
        id: { type: integer }
        task: { type: integer }
        file: { type: string, format: uri, description: "URL to the uploaded file" }
        original_filename: { type: string }
        file_size: { type: integer, description: "File size in bytes" }
        content_type: { type: string, description: "MIME type of the file" }
        checksum: { type: string, description: "SHA-256 checksum of the file" }
        scan_status: 
          type: string
          enum: [pending, scanning, clean, infected, error_scanning]
          description: "Virus scan status"
        uploaded_by: { $ref: "#/components/schemas/UserSummary" }
        created_at: { type: string, format: date-time }

    TaskAttachmentDownload:
      type: object
      properties:
        task_id: { type: integer }
        task_summary: { type: string }
        attachment_id: { type: integer }
        file_name: { type: string }
        file_size: { type: integer }
        content_type: { type: string }
        checksum: { type: string }
        scan_status: { type: string }
        uploaded_at: { type: string, format: date-time }
        uploaded_by: { type: string }
        download_url: { type: string, format: uri }

    TaskRelationsResponse:
      type: object
      description: Task relations grouped by relationship type
      properties:
        causes:
          type: array
          description: Tasks that this task causes
          items:
            $ref: "#/components/schemas/Task"
        is_caused_by:
          type: array
          description: Tasks that cause this task
          items:
            $ref: "#/components/schemas/Task"
        blocks:
          type: array
          description: Tasks that this task blocks
          items:
            $ref: "#/components/schemas/Task"
        is_blocked_by:
          type: array
          description: Tasks that block this task
          items:
            $ref: "#/components/schemas/Task"
        clones:
          type: array
          description: Tasks that this task clones
          items:
            $ref: "#/components/schemas/Task"
        is_cloned_by:
          type: array
          description: Tasks that clone this task
          items:
            $ref: "#/components/schemas/Task"
        relates_to:
          type: array
          description: Tasks related to this task (bidirectional)
          items:
            $ref: "#/components/schemas/Task"

    TaskRelationResponse:
      type: object
      description: Response after adding a task relation
      properties:
        message:
          type: string
          example: "Relation causes added successfully"
        source_task_id:
          type: integer
          description: ID of the source task
        target_task_id:
          type: integer
          description: ID of the target task
        relationship_type:
          type: string
          enum: [causes, blocks, clones, relates_to]
          description: Type of relationship
