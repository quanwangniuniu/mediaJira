services:
  # Redis Service for WebSocket functionality
  redis:
    image: redis:7-alpine
    container_name: redis-dev
    restart: always
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # SonarQube
  sonarqube:
    build: 
      context: ./devops/sonarqube
      dockerfile: Dockerfile.dev
    container_name: sonarqube-dev
    restart: always
    ports:
      - "9000:9000"
    env_file:
      - .env
    environment:
      - SONAR_USER=${SONAR_USER}
      - SONAR_PWD=${SONAR_PWD}
    volumes:
      - sonar-token-data:/token
      - ./devops/sonarqube/init-sonar:/docker-entrypoint-init.d/init-sonar
    command: ["/bin/bash", "/docker-entrypoint-init.d/init-sonar"]
    healthcheck:
      test: ["CMD-SHELL", "curl -u ${SONAR_USER}:${SONAR_PWD} -s http://localhost:9000/api/system/health | grep -q GREEN || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s


  # ClamAV Service for virus scanning
  clamav:
    image: clamav/clamav:latest
    platform: linux/amd64
    container_name: clamav-dev
    restart: always
    ports:
      - "3310:3310"
    volumes:
      - clamav_data:/var/lib/clamav
    healthcheck:
      test: ["CMD", "clamdscan", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Django Backend (Development)
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: backend-dev
    restart: always
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - DB_HOST=host.docker.internal
      - DEBUG=True
      - SONAR_USER=${SONAR_USER}
      - SONAR_PWD=${SONAR_PWD}
      - OTEL_SERVICE_NAME=django-backend
      - OTEL_TRACES_SAMPLER=always_on
      - KAFKA_BROKER=${KAFKA_BROKER}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
      clamav:
        condition: service_healthy
      sonarqube:
        condition: service_healthy
    volumes:
      - sonar-token-data:/token
    command: ["/bin/bash", "/app/entrypoint-dev"]
    logging:
      driver: "fluentd"
      options:
        fluentd-address: localhost:24224
        tag: django    

  # Next.js Frontend (Development)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: frontend-dev
    restart: always
    ports:
      - "3000:3000"
    env_file:
      - .env
    volumes:
      - frontend_node_modules:/app/node_modules
      - frontend_next:/app/.next
      - sonar-token-data:/token
    environment:
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
      - SONAR_USER=${SONAR_USER}
      - SONAR_PWD=${SONAR_PWD}
      - KAFKA_BROKER=${KAFKA_BROKER}
    depends_on:
      - backend
      - sonarqube
    command: ["/bin/bash", "/app/entrypoint-dev"]
    logging:
      driver: "fluentd"
      options:
        fluentd-address: localhost:24224
        tag: nextjs    

  # Nginx Reverse Proxy
  nginx:
    image: nginx:latest
    container_name: nginx-dev
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend
      - frontend

  # Celery Worker for background tasks
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: celery-worker-dev
    restart: always
    env_file:
      - .env
    environment:
      - DB_HOST=host.docker.internal
      - DEBUG=True
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
      clamav:
        condition: service_healthy
    volumes:
      - ./backend:/app
    command: celery -A backend worker --loglevel=info

  # Ngrok tunnel service
  ngrok:
    image: ngrok/ngrok:latest
    container_name: ngrok-dev
    restart: always
    env_file:
      - .env
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    volumes:
      - ./ngrok.yml:/etc/ngrok.yml:ro
    command: start --all --config /etc/ngrok.yml
    depends_on:
      - backend

  prometheus:
    image: prom/prometheus
    volumes:
      - ./devops/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    depends_on:
      - backend
      - frontend

  loki:
    image: grafana/loki:2.9.0
    ports:
      - "3100:3100"

  grafana:
    image: grafana/grafana
    ports:
      - "3001:3000"
    depends_on:
      - backend
      - frontend
      - prometheus

  fluentbit:
    image: fluent/fluent-bit:latest
    volumes:
      - ./devops/fluentbit/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf
    ports:
      - "2020:2020"  
      - "24224:24224"
      
  jaeger:
    image: jaegertracing/all-in-one:1.57
    restart: always
    ports:
      - "16686:16686"   # Jaeger UI
      - "6831:6831/udp" # Agent UDP
    depends_on:
      - backend
      - frontend

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    volumes:
      - zookeeper_data:/var/lib/zookeeper
    healthcheck:
      test: ["CMD", "echo", "ruok", "|", "nc", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    volumes:
      - kafka_data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "9092"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8081:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    depends_on:
      - kafka

  kcat:
    image: edenhill/kcat:1.7.1
    container_name: kcat
    entrypoint: ["sh", "-c", "sleep 999999"]


volumes:
  clamav_data: 
  sonar-token-data:
  frontend_node_modules:
  frontend_next:
  zookeeper_data:
  kafka_data: