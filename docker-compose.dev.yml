version: "3.8"

services:
  # Redis Service for WebSocket functionality
  redis:
    image: redis:7-alpine
    container_name: redis-dev
    restart: always
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # SonarQube
  sonarqube:
    build: 
      context: ./sonarqube
      dockerfile: Dockerfile.dev
    container_name: sonarqube-dev
    restart: always
    ports:
      - "9000:9000"
    volumes:
      - sonar-token-data:/token
      - ./init-sonar:/docker-entrypoint-init.d/init-sonar
    command: ["/bin/bash", "/docker-entrypoint-init.d/init-sonar"]
    healthcheck:
      test: ["CMD-SHELL", "curl -u admin:admin -s http://localhost:9000/api/system/health | grep -q GREEN || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s



  # ClamAV Service for virus scanning
  clamav:
    image: clamav/clamav:1.3
    platform: linux/amd64
    container_name: clamav-dev
    restart: always
    ports:
      - "3310:3310"
    volumes:
      - clamav_data:/var/lib/clamav
    healthcheck:
      test: ["CMD", "clamdscan", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Django Backend (Development)
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: backend-dev
    restart: always
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - DB_HOST=host.docker.internal
      - DEBUG=True
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
      clamav:
        condition: service_healthy
      sonarqube:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - sonar-token-data:/token
    command: ["/bin/bash", "/app/entrypoint"]

  # Next.js Frontend (Development)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend-dev
    restart: always
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
      - sonar-token-data:/token
    environment:
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
    depends_on:
      - backend
      - sonarqube
    command: ["/bin/bash", "/app/entrypoint"]

  # Nginx Reverse Proxy
  nginx:
    image: nginx:latest
    container_name: nginx-dev
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend
      - frontend

  # Celery Worker for background tasks
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: celery-worker-dev
    restart: always
    env_file:
      - .env
    environment:
      - DB_HOST=host.docker.internal
      - DEBUG=True
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
      clamav:
        condition: service_healthy
    volumes:
      - ./backend:/app
    command: celery -A backend worker --loglevel=info

  # Ngrok tunnel service
  ngrok:
    image: ngrok/ngrok:latest
    container_name: ngrok-dev
    restart: always
    env_file:
      - .env
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    volumes:
      - ./ngrok.yml:/etc/ngrok.yml:ro
    command: start --all --config /etc/ngrok.yml
    depends_on:
      - backend

volumes:
  clamav_data: 
  sonar-token-data: